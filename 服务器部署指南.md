# TransCox-Sparse 服务器部署指南

## 目录
1. [部署方式概览](#部署方式概览)
2. [Docker 部署（推荐）](#docker-部署推荐)
3. [直接部署](#直接部署)
4. [云服务器部署](#云服务器部署)
5. [性能优化](#性能优化)
6. [监控与维护](#监控与维护)

## 部署方式概览

### 推荐部署方式
1. **Docker 容器化部署**（推荐）- 环境隔离，易于管理
2. **直接部署** - 适合开发环境
3. **云服务器部署** - 适合生产环境

## Docker 部署（推荐）

### 前置要求
- Docker 20.10+
- Docker Compose 2.0+
- 至少 4GB RAM
- 至少 10GB 磁盘空间

### 快速部署

```bash
# 1. 克隆项目
git clone https://github.com/yourusername/TransCox-Sparse.git
cd TransCox-Sparse

# 2. 构建并启动容器
docker-compose up -d

# 3. 查看容器状态
docker-compose ps

# 4. 进入容器
docker exec -it transcox-sparse R
```

### 自定义配置

#### 修改 docker-compose.yml
```yaml
services:
  transcox-sparse:
    build: .
    volumes:
      - ./your_data:/app/data          # 挂载数据目录
      - ./your_results:/app/results    # 挂载结果目录
    environment:
      - MEMORY_LIMIT=8G               # 设置内存限制
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'
```

### 使用 RStudio Server
```bash
# 启动 RStudio Server
docker-compose up rstudio -d

# 访问 http://your-server:8787
# 用户名: rstudio
# 密码: transcox123
```

## 直接部署

### Ubuntu/Debian 系统

```bash
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装 R
sudo apt install -y r-base r-base-dev

# 3. 安装系统依赖
sudo apt install -y \
    libcurl4-openssl-dev \
    libssl-dev \
    libxml2-dev \
    python3 \
    python3-pip \
    python3-venv

# 4. 创建 Python 虚拟环境
python3 -m venv transcox_env
source transcox_env/bin/activate
pip install numpy torch

# 5. 克隆项目
git clone https://github.com/yourusername/TransCox-Sparse.git
cd TransCox-Sparse

# 6. 安装 R 依赖
Rscript setup_environment.R

# 7. 测试安装
Rscript -e "source('R/runTransCox_Sparse.R'); print('安装成功')"
```

### CentOS/RHEL 系统

```bash
# 1. 安装 EPEL 仓库
sudo yum install -y epel-release

# 2. 安装 R
sudo yum install -y R

# 3. 安装开发工具
sudo yum groupinstall -y "Development Tools"
sudo yum install -y \
    libcurl-devel \
    openssl-devel \
    libxml2-devel \
    python3 \
    python3-pip

# 4. 后续步骤同 Ubuntu
```

## 云服务器部署

### AWS EC2 部署

#### 1. 创建 EC2 实例
```bash
# 推荐配置
# 实例类型: t3.large (2 vCPU, 8GB RAM)
# 操作系统: Ubuntu 22.04 LTS
# 存储: 20GB gp3
```

#### 2. 安全组配置
```bash
# 开放端口
22    (SSH)
3838  (Shiny 应用)
8787  (RStudio Server)
```

#### 3. 部署脚本
```bash
#!/bin/bash
# aws_deploy.sh

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 克隆项目
git clone https://github.com/yourusername/TransCox-Sparse.git
cd TransCox-Sparse

# 启动服务
docker-compose up -d

echo "部署完成！"
echo "RStudio Server: http://$(curl -s ifconfig.me):8787"
```

### 阿里云 ECS 部署

#### 1. 创建 ECS 实例
```bash
# 推荐配置
# 实例规格: ecs.c6.large (2 vCPU, 4GB RAM)
# 操作系统: Ubuntu 22.04
# 系统盘: 40GB ESSD
```

#### 2. 安全组规则
```bash
# 入方向规则
22/22     TCP  0.0.0.0/0    SSH
3838/3838 TCP  0.0.0.0/0    Shiny
8787/8787 TCP  0.0.0.0/0    RStudio
```

#### 3. 一键部署脚本
```bash
#!/bin/bash
# aliyun_deploy.sh

# 配置阿里云镜像源
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
sudo sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

# 安装 Docker（使用阿里云镜像）
curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# 配置 Docker 镜像加速
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://mirror.ccs.tencentyun.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker

# 部署应用
git clone https://github.com/yourusername/TransCox-Sparse.git
cd TransCox-Sparse
docker-compose up -d
```

## 性能优化

### 1. 内存优化
```bash
# 设置 R 内存限制
export R_MAX_VSIZE=8G

# 在 R 中设置
options(java.parameters = "-Xmx8g")
```

### 2. CPU 优化
```r
# 设置并行计算核心数
library(parallel)
options(mc.cores = detectCores() - 1)
```

### 3. 磁盘优化
```bash
# 使用 SSD 存储
# 设置临时目录到高速存储
export TMPDIR=/fast_storage/tmp
```

### 4. 网络优化
```bash
# 配置防火墙
sudo ufw allow 22
sudo ufw allow 3838
sudo ufw allow 8787
sudo ufw enable
```

## 监控与维护

### 1. 容器监控
```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f transcox-sparse

# 查看资源使用
docker stats
```

### 2. 系统监控
```bash
# 安装监控工具
sudo apt install -y htop iotop nethogs

# 监控脚本
#!/bin/bash
# monitor.sh
while true; do
    echo "=== $(date) ==="
    echo "CPU使用率: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)"
    echo "内存使用: $(free -h | grep Mem | awk '{print $3"/"$2}')"
    echo "磁盘使用: $(df -h / | tail -1 | awk '{print $5}')"
    echo "Docker容器状态:"
    docker-compose ps
    echo "========================"
    sleep 60
done
```

### 3. 自动备份
```bash
#!/bin/bash
# backup.sh
BACKUP_DIR="/backup/transcox"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据
tar -czf $BACKUP_DIR/transcox_backup_$DATE.tar.gz \
    /app/data \
    /app/results \
    /app/R

# 清理旧备份（保留7天）
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: transcox_backup_$DATE.tar.gz"
```

### 4. 自动更新
```bash
#!/bin/bash
# update.sh
cd /path/to/TransCox-Sparse

# 拉取最新代码
git pull origin main

# 重新构建容器
docker-compose down
docker-compose build --no-cache
docker-compose up -d

echo "更新完成"
```

## 故障排除

### 常见问题

#### 1. 内存不足
```bash
# 症状：R 进程被杀死
# 解决：增加内存或使用交换文件
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

#### 2. 端口冲突
```bash
# 症状：容器启动失败
# 解决：修改 docker-compose.yml 中的端口映射
ports:
  - "8788:8787"  # 改为其他端口
```

#### 3. 权限问题
```bash
# 症状：文件访问被拒绝
# 解决：修改文件权限
sudo chown -R 1000:1000 /app/data
sudo chmod -R 755 /app/data
```

### 日志分析
```bash
# 查看详细日志
docker-compose logs --tail=100 transcox-sparse

# 查看 R 错误日志
docker exec transcox-sparse cat /tmp/R_errors.log

# 查看系统日志
sudo journalctl -u docker -f
```

## 安全建议

1. **定期更新系统和软件包**
2. **使用强密码和密钥认证**
3. **配置防火墙规则**
4. **定期备份重要数据**
5. **监控异常访问**

## 联系支持

如果在部署过程中遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查 GitHub Issues
3. 联系技术支持

---

**注意**: 请根据实际服务器配置和需求调整部署参数。